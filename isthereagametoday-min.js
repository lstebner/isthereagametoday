function isThereAGameToday(e){var a=moment(),t=5184e3,o=moment().add(1,"days"),s=null,n=null,r=0,d=0,s="",m="No",i="Are the "+e.hashtag+" playing today? ",l="",u=e.formatted_schedule,p=null,c="",h=moment(new Date(u[0].start_date+" "+u[0].start_time)),f=[],g=0;if(a.unix()<h.unix())m="No",c=h.get("month")==a.get("month")&&h.get("date")==a.get("date")+1?"tomorrow":h.format("dddd"),l="mlb"==e.league?"Spring training is coming! It starts "+("tomorrow"!=c?"on":"")+c+", "+h.format("MMMM Do")+" at "+u[0].location+" @ "+h.format("h:mma"):"The season starts "+("tomorrow"!=c?"on":"")+c+", "+h.format("M/D")+" at the "+u[0].location.substr(0,u[0].location.indexOf(" -")),i+=l;else for(var y in u){if(h=moment(new Date(u[y].start_date+" "+u[y].start_time)),n=moment(new Date(u[y].end_date+" "+u[y].end_time)),a.format("MMDD")==h.format("MMDD")){m="Yes",i+="Yes!",a.unix()<n.unix()?a.unix()>h.unix()?(l="they're playing right now at "+u[y].location+" against the "+u[y].against+"!",i+=" Right now against the "+u[y].against+"! "+e.hashtag_during_game):(s=h.format("h:mma"),l="at "+u[y].location+" against The "+u[y].against+" @ "+s,i+=" Starting at "+s+" against the "+u[y].against):(l="but it's already over.",u.length>y&&(p=moment(new Date(u[parseInt(y)+1].start_date)),"Invalid Date"!=p&&(c=h.get("month")==a.get("month")&&h.get("date")==a.get("date")+1?"tomorrow":p.format("dddd"),l+=" The next game is scheduled for "+c+" at "+u[parseInt(y)+1].location+" @ "+p.format("h:mma")))),g=y;break}if("no"==m.toLowerCase()&&n.unix()>a.unix()){p=moment(new Date(u[y].start_date+" "+u[y].start_time)),p.isValid()&&(c=p.get("day")==a.get("day")+1?"tomorrow":p.format("dddd"),l="Not today, looks like the next scheduled game is "+c+" at "+u[y].location+" @ "+p.format("h:mma"),i+="Not today, the next scheduled game is "+c+" at "+u[y].location+" @ "+p.format("h:mma")),g=y;break}}return f=u.slice(g,parseInt(g)+5),_.each(f,function(a,t){var o=moment(new Date(a.start_date+" "+a.start_time));f[t].datetime=o.valueOf(),f[t].date_formatted=o.format("M/D"),"mlb"==e.league?f[t].details=a.against+" at "+a.location+" @ "+o.format("h:mma"):f[t].details=a.against+" at the "+a.location.substr(0,a.location.indexOf(" -"))+". Puck drops at "+o.format("h:mma")}),{is_there:m,tweet_text:i,details:l,start_date:h?h.valueOf():null,month:h.format("MMMM"),day:h.format("dddd"),next_game_start_date:p?p.valueOf():null,upcoming_games:f}}var FAVICON_VERSION=2,express=require("express"),routes=require("./routes"),user=require("./routes/user"),http=require("http"),path=require("path"),fs=require("fs"),_=require("underscore"),_str=require("underscore.string"),moment=require("moment"),app=express();app.set("port",3035),app.set("views",path.join(__dirname,"views")),app.set("view engine","jade"),app.use(express.logger("dev")),app.use(express.json()),app.use(express.urlencoded()),app.use(express.methodOverride()),app.use(app.router),app.use(express["static"](path.join(__dirname,"public")));var conf={ads_enabled:!0,data_year:2015},teams_data={};fs.readFile(__dirname+"/teams_data.json",function(e,a){if(!e){var t=JSON.parse(a);t&&_.each(t,function(e){teams_data[e.slug]=_.extend({schedule:[]},e),load_games_data(e.slug,!0)})}});var load_games_data=function(e,a){var t=[],o=function(){a&&(_.has(teams_data,e)||(teams_data[e]={}),teams_data[e].schedule=t,teams_data[e].formatted_schedule=[],_.each(t,function(a,o){var s={};o>0&&(_.each(t[0],function(e,t){e=e.toLowerCase(),s[e]=a[t]}),teams_data[e].formatted_schedule.push(s))}))};fs.readFile(__dirname+"/schedules/"+conf.data_year+"_"+e+".csv","UTF-8",function(e,a){e||(_.each(a.split("\n"),function(e,a){_.isEmpty(e)||t.push(e.split(","))}),o())})};"development"==app.get("env")&&(app.use(express.errorHandler()),conf.ads_enabled=!1),app.get("/:team/sitemap",function(e,a){var t=e.params.team.toLowerCase();_.indexOf(_.keys(teams_data),t)>-1?(team_data=teams_data[t],a.render("sitemap",{layout:!1,today:moment().format("YYYY-MM-DD"),base_url:"http://www."+team_data.track_url,conf:conf})):a.send("404","sorry!")}),app.get("/:team",function(e,a){var t=e.params.team.toLowerCase(),o={};_.indexOf(_.keys(teams_data),t)>-1?(o=teams_data[t],today_data=isThereAGameToday(o),layout="index","nhl"==o.league&&(layout="index_new"),a.render(layout,{title:"Are the "+o.name+" Playing Today?",base_url:"http://"+e.headers.host,team_name:t,team_data:o,team_data_clean:_.omit(o,"schedule","formatted_schedule"),teams_data:teams_data,today_data:today_data,meta_description:"Find out if the "+o.name+" are playing a "+("mlb"==o.league?"baseball":"hockey")+" game today!",favicon_version:FAVICON_VERSION,conf:conf})):a.send("404","not found")}),app.get("/:team/schedule/:month?",function(e,a){var t=e.params.team.toLowerCase(),o={},s=[],n={};if(_.indexOf(_.keys(teams_data),t)>-1){o=teams_data[t],today_data=isThereAGameToday(o),_.each(o.formatted_schedule,function(e){var a=moment(new Date(e.start_date+" "+e.start_time)),t=a.format("MMMM");_.indexOf(s,t)<0&&(s.push(t),n[t]=[]),n[t].push({datetime:a.valueOf(),date_formatted:a.format("dddd M/DD/YYYY"),details:e.against+" at "+e.location+" @ "+a.format("H:mma")})});var r=_.first(_.keys(n)),d=e.params.month?e.params.month.toLowerCase():!1,m=d?!1:r;a.render("schedule",{title:o.name+" "+conf.data_year+" "+(d?_str.capitalize(d):_str.capitalize(r))+" Schedule",base_url:"http://www."+o.track_url,team_name:t,team_data:o,team_data_clean:_.omit(o,"schedule","formatted_schedule"),teams_data:teams_data,today_data:today_data,months:s,games_by_month:n,selected_month:d,is_canonical:m,meta_description:"View the "+conf.data_year+" Schedule for the "+o.name,favicon_version:FAVICON_VERSION,schedule_url:"development"==app.get("env")?"/"+o.slug+"/schedule":"/schedule",conf:conf})}else a.send("404","not found")}),app.get("/games-data/:team",function(e,a){var t=e.params.team.toLowerCase();_.indexOf(_.keys(teams_data),t)>-1?a.json(teams_data[t].schedule):a.json({error:"not found"})}),app.get("/",function(e,a){a.render("listing",{teams:_.keys(teams_data)})}),http.createServer(app).listen(app.get("port"),function(){console.log("Express server listening on port "+app.get("port"))});