function isThereAGameToday(e){var a=moment(),t=5184e3,s=moment().add(1,"days"),n=null,r=null,o=0,d=0,n="",m="No",i="Are the "+e.hashtag+" playing today? ",u="",l=e.formatted_schedule,p=null,c="",h=moment(new Date(l[0].start_date+" "+l[0].start_time)),f=[],g=0;if(a.unix()<h.unix())m="No",c=h.get("month")==a.get("month")&&h.get("date")==a.get("date")+1?"tomorrow":h.format("dddd"),u="Spring training is coming! It starts on "+c+", "+h.format("MMMM Do")+" at "+l[0].location+" @ "+h.format("h:mma"),i+=u;else for(var y in l){if(h=moment(new Date(l[y].start_date+" "+l[y].start_time)),r=moment(new Date(l[y].end_date+" "+l[y].end_time)),a.format("MMDD")==h.format("MMDD")){m="Yes",i+="Yes!",a.unix()<r.unix()?a.unix()>h.unix()?(u="they're playing right now at "+l[y].location+" against the "+l[y].against+"!",i+=" Right now against the "+l[y].against+"! "+e.hashtag_during_game):(n=h.format("h:mma"),u="at "+l[y].location+" against The "+l[y].against+" @ "+n,i+=" Starting at "+n+" against the "+l[y].against):(u="but it's already over.",l.length>y&&(p=moment(new Date(l[parseInt(y)+1].start_date)),"Invalid Date"!=p&&(c=h.get("month")==a.get("month")&&h.get("date")==a.get("date")+1?"tomorrow":p.format("dddd"),u+=" The next game is scheduled for "+c+" at "+l[parseInt(y)+1].location+" @ "+p.format("h:mma")))),g=y;break}if("no"==m.toLowerCase()&&r.unix()>a.unix()){p=moment(new Date(l[y].start_date+" "+l[y].start_time)),p.isValid()&&(c=p.get("day")==a.get("day")+1?"tomorrow":p.format("dddd"),u="Not today, looks like the next scheduled game is "+c+" at "+l[y].location+" @ "+p.format("h:mma"),i+="Not today, the next scheduled game is "+c+" at "+l[y].location+" @ "+p.format("h:mma")),g=y;break}}return f=l.slice(g,parseInt(g)+3),_.each(f,function(e,a){var t=moment(new Date(e.start_date+" "+e.start_time));f[a].datetime=t.valueOf(),f[a].date_formatted=t.format("dddd M/DD/YYYY"),f[a].details=e.against+" at "+e.location+" @ "+t.format("H:mma")}),{is_there:m,tweet_text:i,details:u,start_date:h?h.valueOf():null,month:h.format("MMMM"),day:h.format("dddd"),next_game_start_date:p?p.valueOf():null,upcoming_games:f}}var FAVICON_VERSION=2,express=require("express"),routes=require("./routes"),user=require("./routes/user"),http=require("http"),path=require("path"),fs=require("fs"),_=require("underscore"),_str=require("underscore.string"),moment=require("moment"),app=express();app.set("port",3035),app.set("views",path.join(__dirname,"views")),app.set("view engine","jade"),app.use(express.logger("dev")),app.use(express.json()),app.use(express.urlencoded()),app.use(express.methodOverride()),app.use(app.router),app.use(express.static(path.join(__dirname,"public")));var conf={ads_enabled:!1,data_year:2015},teams_data={};fs.readFile(__dirname+"/teams_data.json",function(e,a){if(!e){var t=JSON.parse(a);t&&_.each(t,function(e){teams_data[e.slug]=_.extend({schedule:[]},e),load_games_data(e.slug,!0)})}});var load_games_data=function(e,a){var t=[],s=function(){a&&(_.has(teams_data,e)||(teams_data[e]={}),teams_data[e].schedule=t,teams_data[e].formatted_schedule=[],_.each(t,function(a,s){var n={};s>0&&(_.each(t[0],function(e,t){e=e.toLowerCase(),n[e]=a[t]}),teams_data[e].formatted_schedule.push(n))}))};fs.readFile(__dirname+"/schedules/"+conf.data_year+"_"+e+".csv","UTF-8",function(e,a){e||(_.each(a.split("\n"),function(e,a){_.isEmpty(e)||t.push(e.split(","))}),s())})};"development"==app.get("env")&&(app.use(express.errorHandler()),conf.ads_enabled=!1),app.get("/:team/sitemap",function(e,a){var t=e.params.team.toLowerCase();_.indexOf(_.keys(teams_data),t)>-1?(team_data=teams_data[t],a.render("sitemap",{layout:!1,today:moment().format("YYYY-MM-DD"),base_url:"http://www."+team_data.track_url,conf:conf})):a.send("404","sorry!")}),app.get("/:team",function(e,a){var t=e.params.team.toLowerCase(),s={};_.indexOf(_.keys(teams_data),t)>-1?(s=teams_data[t],today_data=isThereAGameToday(s),a.render("index",{title:"Are the "+s.name+" Playing Today?",base_url:"http://"+e.headers.host,team_name:t,team_data:s,team_data_clean:_.omit(s,"schedule","formatted_schedule"),teams_data:teams_data,today_data:today_data,meta_description:"Find out if the "+s.name+" are playing a baseball game today!",favicon_version:FAVICON_VERSION,conf:conf})):a.send("404","not found")}),app.get("/:team/schedule/:month?",function(e,a){var t=e.params.team.toLowerCase(),s={},n=[],r={};if(_.indexOf(_.keys(teams_data),t)>-1){s=teams_data[t],today_data=isThereAGameToday(s),_.each(s.formatted_schedule,function(e){var a=moment(new Date(e.start_date+" "+e.start_time)),t=a.format("MMMM");_.indexOf(n,t)<0&&(n.push(t),r[t]=[]),r[t].push({datetime:a.valueOf(),date_formatted:a.format("dddd M/DD/YYYY"),details:e.against+" at "+e.location+" @ "+a.format("H:mma")})});var o=_.first(_.keys(r)),d=e.params.month?e.params.month.toLowerCase():!1,m=d?!1:o;a.render("schedule",{title:s.name+" "+conf.data_year+" "+_str.capitalize(d?d:o)+" Schedule",base_url:"http://www."+s.track_url,team_name:t,team_data:s,team_data_clean:_.omit(s,"schedule","formatted_schedule"),teams_data:teams_data,today_data:today_data,months:n,games_by_month:r,selected_month:d,is_canonical:m,meta_description:"View the "+conf.data_year+" Schedule for the "+s.name,favicon_version:FAVICON_VERSION,schedule_url:"development"==app.get("env")?"/"+s.slug+"/schedule":"/schedule",conf:conf})}else a.send("404","not found")}),app.get("/games-data/:team",function(e,a){var t=e.params.team.toLowerCase();a.json(_.indexOf(_.keys(teams_data),t)>-1?teams_data[t].schedule:{error:"not found"})}),app.get("/",function(e,a){a.render("listing",{teams:_.keys(teams_data)})}),http.createServer(app).listen(app.get("port"),function(){console.log("Express server listening on port "+app.get("port"))});